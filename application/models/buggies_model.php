<?phpclass Buggies_model extends KM_Model { 	 function __construct(){	 	parent::__construct(); 	 }	 	 public function outletsAbstract(){ $sql="select  ol_id,  outlet,  sum(scanned_qrc)  scanned_qrc from (select  o.ol_id,a.userid,  o.outlet,  count(distinct q.qrcid)    scanned_qrcfrom act_log a  inner join qrc q    on a.qrcid = q.qrcid      and a.action = 'scan'inner join user u on u.id = a.userid and a.qrcid != 0  inner join retailer r    on q.retid = r.retid  right join (select                ol_id,                outlet              from outlets              where retid = '".$this->admin_session['retid']."') o    on q.locid = o.ol_idgroup by a.userid,o.outlet)a group by outlet";		$query=$this->db->query($sql);			return $query->result_array();	 	 }	 	 	 public function customersUsages($offset,$limit){	 		 $outlet=$this->input->post('outlet');		 		 /* $sql=" select a.userid id,username,email,actdt, smt_qr_scanned, fav, ret,ifnull(other_qr_scaned,0) as other_qr_scanned from (select l.userid,m.username,m.email,date(actdt) as actdt,ifnull(m.smt_qr_scanned,0)   smt_qr_scanned,    m.fav,m.ret from act_log l,(select u.id,al.userid,max(date(actdt)) as ldate,al.qrcid,u.username,u.email,count(distinct al.qrcid) smt_qr_scanned,count(distinct(f.qrcid)) as fav,o.outlet as    ret from user uinner join act_log al on u.id = al.userid  and al.qrcid != 0inner join qrc qr on qr.qrcid = al.qrcid  left join qr_data q on al.logid = q.log_id  left join favs f on f.userid = u.id and f.qrcid = al.qrcid and f.isfavstill = 1  left join outlets o on o.ol_id=qr.locidwhere u.role = 2 and qr.retid = '".$this->admin_session['retid']."' and  al.action = 'scan'"; if($outlet) $sql.=" and qr.locid= $outlet "; $sql.=" group by al.userid)m where l.userid = m.userid and  date(actdt) = m.ldate group by userid)aleft join (select userid,case when l.action = 'scan' and l.qrcid = 0 then count(l.qrcid) end as other_qr_scaned from act_log l  where l.action = 'scan' and qrcid = 0 group by userid)b on a.userid = b.userid order by actdt desc limit $offset,$limit";*/$sql="select a.userid id,username,email,actdt, smt_qr_scanned, fav, ret,ifnull(other_qr_scaned,0) as other_qr_scanned from (select l.userid,m.username,m.email,date(actdt) as actdt,ifnull(m.smt_qr_scanned,0)   smt_qr_scanned,    m.fav,m.ret from act_log l,(select u.id,al.userid,max(date(actdt)) as ldate,al.qrcid,u.username,u.email,count(distinct al.qrcid) smt_qr_scanned,count(distinct(f.qrcid)) as fav,o.outlet as ret from user uinner join act_log al on u.id = al.userid  -- and al.qrcid != 0inner join qrc q on q.qrcid = al.qrcid and q.isnew = 0 left join qr_data qr on al.logid = qr.log_idleft join favs f on f.userid = u.id and f.qrcid = al.qrcid and f.isfavstill = 1left join outlets o on o.ol_id=q.locidwhere u.role = 2 and q.retid = '".$this->admin_session['retid']."' and  al.action = 'scan'";if($outlet) $sql.=" and q.locid= $outlet "; $sql.=" group by al.userid)mwhere l.userid = m.userid and  date(actdt) = m.ldate group by userid)aleft join (select userid,count(distinct(l.qrcid)) as other_qr_scaned from act_log l inner join qrc q on l.qrcid = q.qrcid where l.action = 'scan' and q.isnew = 1 and userid >= 1 group by userid)b on a.userid = b.userid order by actdt desc limit $offset,$limit";				$query=$this->db->query($sql);			return $query->result_array();	 	 }	 	 	 public function customersUsages_count(){	 		 $outlet=$this->input->post('outlet');		 		 $sql="select count(*) num_rec from(		 select u.id from user u			left join act_log l on  u.id=l.userid  and l.qrcid !=0			left join qrc qr on qr.qrcid=l.qrcid			left join  qr_data q on l.logid = q.log_id			left join  favs f on f.userid=u.id and f.qrcid=l.qrcid			where u.role=2  and qr.retid = '".$this->admin_session['retid']."' and l.action='scan' ";		 if($outlet) $sql.=" and qr.locid= $outlet";			$sql.=" group by u.id  			order by username )a ";				$query=$this->db->query($sql);				$data = $query->result_array();	 			return isset($data[0]['num_rec'])?$data[0]['num_rec']:0;	 }	 	  public function customersUsageCounts($uid=0){	 		 $outlet=$this->input->post('outlet');		 		  $cat=$this->input->post('cat');		 		 $catid=0;		 if(strpos($cat,'_') !== false){		 	$catdata = explode('_',$cat); 			$catid=$catdata[0];			$subcatid=$catdata[1]; 		 }		 else{		 	$catid=$cat;			$subcatid=0;		 		 }		 /*$sql="select sum(m.smt_scaned) as smt_scanned,sum(m.active_product)as active_product,sum(m.tot_fav) as tot_fav,sum(m.tot_outlets) as tot_outlets,sum(m.other_scaned) as other_scanned from(select a.smt_scaned,a.active_product,a.tot_fav,a.tot_outlets,ifnull(other_qr_scaned,0) as 'other_scaned' from(select al.userid, count(distinct al.qrcid) smt_scaned, count(distinct(al.qrcid)) active_product,count(distinct(f.qrcid)) as tot_fav,count(distinct qr.locid)    tot_outlets from user uinner join act_log al on u.id = al.userid  and al.qrcid != 0inner join qrc qr on qr.qrcid = al.qrcidinner join product p  on p.pid = qr.pidinner join subcat s on s.scatid = p.subcatinner join retailer r on r.retid = qr.retidinner join outlets o on o.retid = r.retid and o.ol_id = qr.locid  left join qr_data q on al.logid = q.log_id  left join favs f on f.userid = u.id and f.qrcid = al.qrcid and f.isfavstill = 1where qr.retid = '".$this->admin_session['retid']."' and  al.action = 'scan'"; if($uid>0) $sql.=" and al.userid=$uid ";			if($subcatid!=0) $sql.=" and p.subcat= $subcatid ";		if($catid!=0) $sql.=" and s.catid= $catid "; $sql.=	"	group by qr.qrcid,al.userid,o.ol_id)aleft join (select userid,case when l.action = 'scan' and l.qrcid = 0 and userid >= 1 then count(l.qrcid) end as other_qr_scaned from act_log l  where l.action = 'scan' and qrcid = 0 group by userid)b on a.userid = b.userid )m";*/$sql="select sum(b.smt_scanned) as smt_scanned, sum(b.active_product) as active_product, sum(b.tot_fav) as tot_fav, sum(b.tot_outlets) as tot_outlets, sum(ifnull(other_qr_scaned,0)) as  other_scanned from (select a.userid,sum(a.smt_scaned) as smt_scanned,sum(a.active_product)as active_product,sum(a.tot_fav) as tot_fav,sum(a.tot_outlets) as tot_outlets from(select al.userid, count(distinct al.qrcid) smt_scaned,count(distinct(al.qrcid)) active_product, count(distinct(f.qrcid)) as tot_fav, count(distinct q.locid) tot_outlets from user u inner join act_log al on u.id = al.userid -- and al.qrcid != 0 inner join qrc q on q.qrcid = al.qrcid and q.isnew = 0 inner join product p on p.pid = q.pidinner join subcat s on s.scatid = p.subcat inner join retailer r on r.retid = q.retid inner join outlets o on o.retid = r.retid and o.ol_id = q.locid left join qr_data qr on al.logid = qr.log_id left join favs f on f.userid = u.id and f.qrcid = al.qrcid and f.isfavstill = 1 where q.retid = '".$this->admin_session['retid']."' and al.action = 'scan'"; if($uid>0) $sql.=" and al.userid=$uid ";			if($subcatid!=0) $sql.=" and p.subcat= $subcatid ";		if($catid!=0) $sql.=" and s.catid= $catid "; $sql.=	" group by al.userid ,q.qrcid,o.ol_id)agroup by userid)bleft join (select userid,count(distinct(l.qrcid)) as other_qr_scaned from act_log l inner join qrc q on l.qrcid = q.qrcid where l.action = 'scan' and q.isnew = 1 and userid >= 1  group by userid)c on c.userid = b.userid ";		$query=$this->db->query($sql);			$data = $query->result_array();			return isset($data[0])?$data[0]:array("smt_scanned"=>0,"other_scanned"=>0,"tot_fav"=>0,"tot_ret"=>0); 	 }	 	 	 public function favourites($offset,$limit){	 		 $outlet=$this->input->post('outlet');		 $cat=$this->input->post('cat');		 $userid=$this->input->post('userid');		 $catid=0;		 if(strpos($cat,'_') !== false){		 	$catdata = explode('_',$cat); 			$catid=$catdata[0];			$subcatid=$catdata[1]; 		 }		 else{		 	$catid=$cat;			$subcatid=0;		 		 }				 $sql="select p.pname,f.qrcid,q.pid, count(distinct f.userid) as totfav, o.outlet,q.price,a.actdt				from product p				inner join qrc q on p.pid=q.pid				inner join favs f on f.qrcid=q.qrcid and f.isfavstill='1'				inner join retailer r on q.retid=r.retid				inner join act_log a on a.qrcid=q.qrcid 				inner join subcat s on s.scatid=p.subcat				inner join outlets o on o.ol_id = q.locid				where f.isfavstill=1 and a.action='scan' and f.userid is not null and q.retid='".$this->admin_session['retid']."'";				if($userid) $sql.=" and f.userid ='$userid'";				if($outlet) $sql.=" and q.locid= $outlet ";				if($subcatid!=0) $sql.=" and p.subcat= $subcatid ";				if($catid!=0) $sql.=" and s.catid= $catid ";						$sql.=" group by q.pid				order by a.actdt desc, p.pname asc limit $offset,$limit";			$query=$this->db->query($sql);			return $query->result_array();	 	 }	 	 	 public function favourites_count(){	 		 $outlet=$this->input->post('outlet');		 $cat=$this->input->post('cat');		  $userid=$this->input->post('userid');		 $catid=0;		 if(strpos($cat,'_') !== false){		 	$catdata = explode('_',$cat); 			$catid=$catdata[0];			$subcatid=$catdata[1]; 		 }		 else{		 	$catid=$cat;			$subcatid=0;		 		 }		 		 $sql="select count(*) num_rec from(		 select p.pname,f.qrcid,q.pid, count(distinct f.userid) as totfav, o.outlet,q.price,a.actdt				from product p				inner join qrc q on p.pid=q.pid				inner join favs f on f.qrcid=q.qrcid				inner join retailer r on q.retid=r.retid				inner join act_log a on a.qrcid=q.qrcid 				inner join subcat s on s.scatid=p.subcat				inner join outlets o on o.ol_id = q.locid				where f.isfavstill=1 and f.userid is not null and q.retid = '".$this->admin_session['retid']."' ";				if($userid) $sql.=" and f.userid ='$userid'";				if($outlet) $sql.=" and q.locid= $outlet ";				if($subcatid!=0) $sql.=" and p.subcat= $subcatid ";				if($catid!=0) $sql.=" and s.catid= $catid ";						$sql.=" group by q.pid				order by a.actdt desc, p.pname asc   )a ";					$query=$this->db->query($sql);				$data = $query->result_array();	 			return isset($data[0]['num_rec'])?$data[0]['num_rec']:0;	 } 	 	 	 	  public function active_product($offset,$limit){	 		 $outlet=$this->input->post('outlet');		 $cat=$this->input->post('cat');		  $userid=$this->input->post('userid');		 $catid=0;		 if(strpos($cat,'_') !== false){		 	$catdata = explode('_',$cat); 			$catid=$catdata[0];			$subcatid=$catdata[1]; 		 }		 else{		 	$catid=$cat;			$subcatid=0;		 		 }				 $sql="select p.pname,q.qrcid,q.pid, count(distinct f.qrcid) as totfav, o.outlet,q.price,a.actdt				from product p				inner join qrc q on p.pid=q.pid and q.isnew='0'				inner join act_log a on a.qrcid=q.qrcid";								//if($userid) $sql.=" and f.userid ='$userid'";				$sql.=" inner join retailer r on q.retid=r.retid								inner join subcat s on s.scatid=p.subcat				inner join outlets o on o.ol_id = q.locid and o.retid=r.retid				inner join user u on u.id = a.userid and a.qrcid != 0				left join favs f on f.qrcid=q.qrcid and f.userid=u.id and f.isfavstill=1				where  a.action='scan' and q.retid = '".$this->admin_session['retid']."' ";				if($userid) $sql.=" and a.userid ='$userid'";				if($outlet) $sql.=" and q.locid= $outlet ";				if($subcatid!=0) $sql.=" and p.subcat= $subcatid ";				if($catid!=0) $sql.=" and s.catid= $catid ";						$sql.=" group by q.qrcid,a.userid,o.ol_id 				order by a.actdt desc, p.pname asc limit $offset,$limit";				$query=$this->db->query($sql);			return $query->result_array();	 	 }	 	 	 public function active_product_count(){	 		 $outlet=$this->input->post('outlet');		 $cat=$this->input->post('cat');		  $userid=$this->input->post('userid');		 $catid=0;		 if(strpos($cat,'_') !== false){		 	$catdata = explode('_',$cat); 			$catid=$catdata[0];			$subcatid=$catdata[1]; 		 }		 else{		 	$catid=$cat;			$subcatid=0;		 		 }		 		 $sql="select count(*) num_rec from(		 select p.pname,q.qrcid,q.pid, count(distinct f.userid) as totfav, r.retname,q.price,a.actdt				from product p				inner join qrc q on p.pid=q.pid				inner join act_log a on a.qrcid=q.qrcid 				left join favs f on f.qrcid=q.qrcid				inner join retailer r on q.retid=r.retid								inner join subcat s on s.scatid=p.subcat				inner join outlets o on o.ol_id = q.locid				inner join user u on u.id = a.userid and a.qrcid != 0				where  a.action='scan' and q.retid = '".$this->admin_session['retid']."' ";				if($userid) $sql.=" and a.userid ='$userid'";				if($outlet) $sql.=" and q.locid= $outlet ";				if($subcatid!=0) $sql.=" and p.subcat= $subcatid ";				if($catid!=0) $sql.=" and s.catid= $catid ";						$sql.=" group by q.qrcid,a.userid,o.ol_id 				order by a.actdt desc, p.pname asc   )a ";					$query=$this->db->query($sql);				$data = $query->result_array();	 			return isset($data[0]['num_rec'])?$data[0]['num_rec']:0;	 }	 	 	 	 	 public function scanned_products($offset,$limit){	 		 $outlet=$this->input->post('outlet');		 $uid=$this->input->post('uid');		 $cat=$this->input->post('cat');		 		 $catid=0;		 if(strpos($cat,'_') !== false){		 	$catdata = explode('_',$cat); 			$catid=$catdata[0];			$subcatid=$catdata[1]; 		 }		 else{		 	$catid=$cat;			$subcatid=0;		 		 }				 $sql="select a.userid,p.pname, q.qrcid, q.pid,c.category ,s.subcategory, count(distinct f.userid) as totfav, o.outlet, q.price, a.actdt				from act_log a 				inner join qrc q on q.qrcid=a.qrcid				inner join product p on p.pid=q.pid				left join favs f on f.qrcid = a.qrcid				inner join retailer r on q.retid = r.retid				inner join subcat s on s.scatid = p.subcat				inner join cat c on c.catid = s.catid				inner join outlets o on o.ol_id = q.locid				where  a.action='scan' and a.userid='$uid' and q.retid = '".$this->admin_session['retid']."' ";								if($outlet) $sql.=" and q.locid= $outlet ";				if($subcatid!=0) $sql.=" and p.subcat= $subcatid ";				if($catid!=0) $sql.=" and s.catid= $catid ";						$sql.=" group by q.qrcid				order by a.actdt desc, p.pname asc limit $offset,$limit ";				 		$query=$this->db->query($sql);			return $query->result_array();	 	 }	 	 	 public function scanned_products_count(){	 		 $outlet=$this->input->post('outlet');		 $uid=$this->input->post('uid');		 $cat=$this->input->post('cat');		 		 $catid=0;		 if(strpos($cat,'_') !== false){		 	$catdata = explode('_',$cat); 			$catid=$catdata[0];			$subcatid=$catdata[1]; 		 }		 else{		 	$catid=$cat;			$subcatid=0;		 		 }		 		 $sql=" select count(*) num_rec from(		 select a.userid,p.pname, q.qrcid, q.pid,c.category ,s.subcategory, count(distinct f.userid) as totfav, o.outlet, q.price, a.actdt				from act_log a 				inner join qrc q on q.qrcid=a.qrcid				inner join product p on p.pid=q.pid				left join favs f on f.qrcid = a.qrcid				inner join retailer r on q.retid = r.retid				inner join subcat s on s.scatid = p.subcat				inner join cat c on c.catid = s.catid				inner join outlets o on o.ol_id = q.locid				where  a.action='scan' and a.userid='$uid' and q.retid = '".$this->admin_session['retid']."' ";								if($outlet) $sql.=" and q.locid= $outlet ";				if($subcatid!=0) $sql.=" and p.subcat= $subcatid ";				if($catid!=0) $sql.=" and s.catid= $catid ";						$sql.=" group by q.pid				order by a.actdt desc, p.pname asc )a ";					$query=$this->db->query($sql);				$data = $query->result_array();	 			return isset($data[0]['num_rec'])?$data[0]['num_rec']:0;	 }	 }?>